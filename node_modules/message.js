var mysql = require('conn');
var evt = require('events');
var evtEmitter = new evt.EventEmitter();
var util = require("util");

var message = function(){
	var t = this;
	evt.EventEmitter.call( t );
	
	t.find = function( id, filter ){
		mysql.local.getConnection(function(err, conn){
			if( err ){
				t.emit('find_error', {error: err.toString()});
			}else{
				var param = [];
				var strSQL = "SELECT * FROM message WHERE 1=1";
				
				if( typeof( filter ) != 'undefined' ){
					if( typeof( filter.status ) != 'undefined' ){
						strSQL += " AND WHERE status = ?";
						param.push(filter.status);
					}
				}
				
				strSQL += " ORDER BY message.id DESC LIMIT 100 OFFSET 0";
				
				conn.query(strSQL, param, function(err, rows){
					if( err ){
						t.emit('find_error', {error: err.toString()});
					}else{
						t.emit('find_success', rows);
					}
					conn.release();
				});
			}
		});
	}
};
util.inherits(message, evt.EventEmitter);

module.exports = message;