var mysql = require('conn');
var evt = require('events');
var evtEmitter = new evt.EventEmitter();
var util = require("util");

var post = function(){
	var t = this;
	evt.EventEmitter.call( t );
	
	t.find = function( filter ){
		// get post from live
		mysql.live.getConnection(function(err, conn){
			if( err ){
				t.emit('find_error', {error: err.toString()});
			}else{
				var param = [];
				var strSQL = "SELECT * FROM post WHERE 1=1";
				
				if( typeof(filter) != 'undefined' ){
					if( typeof(filter.id) != 'undefined' ){
						strSQL += " AND id=?";
						param.push(filter.id);
					}
				}
				
				strSQL += " ORDER BY post.id DESC LIMIT 100 OFFSET 0";
				
				conn.query(strSQL, param, function(err, rows){
					if( err ){
						t.emit('find_error', {error: err.toString()});
					}else{
						t.emit('find_success', rows);
					}
					conn.release();
				});
			}
		});
	}
};
util.inherits(post, evt.EventEmitter);

module.exports = post;